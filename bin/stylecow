#!/usr/bin/env node

var stylecow = require('../lib'),
	info = require('../lib/info'),
	args = process.argv.slice(2);

if (!args.length) {
	info.print();
	process.exit(0);
}

var file = (args[0] && args[0][0] !== '-') ? args.shift() : null;

if (!file) {
	console.log('Filename is required: stylecow <filename> (--options)');
	process.exit(1);
}

var css = stylecow.loadFile(file);

args.forEach(function (arg) {
	var match = arg.match(/^--?([a-z][0-9a-z-]*)(?:=(.*))?$/i);

	if (!match) {
		console.log('Unrecognised argument: ' + arg);
		process.exit(1);
	}

	var name = match[1], value = match[2];

	switch (name) {
		case 'explorer':
		case 'firefox':
		case 'chrome':
		case 'safari':
		case 'opera':
		case 'android':
		case 'ios':
			css.settings.support[name] = parseFloat(value);
			break;

		case 'enable':
		case 'disable':
			value.split(',').forEach(function (val) {
				if (!css.settings.plugins[val]) {
					console.log('The plugin "' + val + '" is missing');
					process.exit(1);
				}

				css.settings.plugins[val].enabled = (name === 'enable');
			});
			break;

		default:
			console.log('Unrecognised argument: ' + arg);
			process.exit(1);
	}
});

css.transform();

process.stdout.write(css.toString() + '\n');
